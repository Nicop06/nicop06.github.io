<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Nicolas Porcel's Blog - How to extract a script from a git repository</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Nicolas Porcel's Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>How to extract a script from a git repository</h1>
            <div class="info">
    Posted on December 22, 2016
    
</div>
<div class="info">
  
  Tags: <a href="../tags/git.html">git</a>
  
</div>

<p>A few days ago, I needed to extract a script from a git repository maintained by another team and import it in our newly created repository. This would allow us to implement our own continuous integration pipeline.</p>
<h2 id="naive-approach">Naive approach</h2>
<p>The first thing I did was to copy paste the script in a new repository and start from here. However, I later realized that I also wanted to keep the changesets of the script from the old repository. To complicate things, the script was also modified in the new one.</p>
<p>For the purpose of this post, let’s call <code>myscript</code> the script I want to import, <code>myrepo</code> the new repository I created to hold this script and <code>oldrepo</code> the repository where it was previously maintained.</p>
<h2 id="extracting-the-history"> Extracting the history</h2>
<p>The first step was to extract the history in the old repository that concerned my script. To do so, I first created a branch to be sure I would lose all my data, although I could always clone the repository later.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="bu">cd</span> /path/to/oldrepo
$ <span class="fu">git</span> checkout -b export_myscript</code></pre></div>
<p>Then, I used <code>filter-branch</code> command from <code>git</code> to only extract the part that concerned my script.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> filter-branch --prune-empty --tree-filter <span class="st">'find -not -name myscript -delete'</span></code></pre></div>
<p>Basically, this will run through each commit of the current branch and execute the command. The <code>find</code> command we execute will delete any file whose name is not <code>myscript</code>. Then, thanks to the <code>--prune-empty</code> option, it will remove the empty commits, which are basically the ones not concerning <code>myscript</code>.</p>
<p>This has the same result as checking out all commits one by one, execute the command you provided and perform a <code>git commit --amend</code>. However, this is much faster and much more powerful.</p>
<p>You can always rollback your changes by doing <code>git reset --hard master</code> if your parent branch was <code>master</code>. Also, the current branch is backed up under the name <code>refs/original/refs/heads/YOUR_BRANCH</code>. So in this case you could do:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> reset --hard refs/original/refs/heads/export_myscript</code></pre></div>
<h2 id="removing-submodules">Removing submodules</h2>
<p>To make things a little more fun, the repository contained a submodule. First, we had to unregister the submodule with the following command.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> submodule deinit mysubmodule</code></pre></div>
<p>Then, we had to remove the submodule folder from all the commits. Because this is not a regular file, it needs to be removed with the <code>git rm</code> command.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> filter-branch -f --prune-empty --index-filter \
    <span class="st">&quot;git rm -r -f --cached --ignore-unmatch mysubmodule&quot;</span></code></pre></div>
<p>The advantage of the <code>--index-filter</code> is that it doesn’t need to checkout the files before executing the command, making it much faster. However, we are limited to the git commands, and filtering all files except our script would be little tricky. Finally, we use the <code>-f</code> flag to remove the backup from the previous run of the <code>filter-branch</code> command.</p>
<h2 id="extracting-a-folder">Extracting a folder</h2>
<p>If you need to extract a folder instead of a file, there is a very simple way to do so. You just need to run the following command:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> filter-branch --subdirectory-filter foodir -- --all</code></pre></div>
<h2 id="importing-the-history-in-the-new-repository">Importing the history in the new repository</h2>
<p>Now, you need to import the history in our repository. To do so, we will import the old repository content in the new one.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="bu">cd</span> /path/to/myrepo
$ <span class="fu">git</span> remote add oldrepo /path/to/oldrepo
$ <span class="fu">git</span> fetch oldrepo export_myscript</code></pre></div>
<p>Then we will reapply all the commits of our repository on top of the <code>export_myscript</code> branch we just imported. We will do that on a new branch called <code>import_myscript</code> in case we do a mistake.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> checkout -b import_myscript
$ <span class="fu">git</span> rebase oldrepo/export_myscript</code></pre></div>
<p>Running <code>git log --stat</code>, you can see that the commit corresponding to the copy of the script in your repository is now empty. In fact, git will recalculate all the diffs between commits and will deduce that <code>myscript</code> didn’t change.</p>
<p>You can now reset your master branch to your <code>import_myscript</code> branch and do some cleanup.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> checkout master
$ <span class="fu">git</span> reset --hard import_myscript
$ <span class="fu">git</span> branch -d import_myscript
$ <span class="fu">git</span> remote rm oldrepo
$ <span class="bu">cd</span> /path/to/oldrepo
$ <span class="fu">git</span> checkout master
$ <span class="fu">git</span> branch -D export_myscript</code></pre></div>
<h2 id="final-thoughts"> Final thoughts</h2>
<p>This article should give you some glimpse at the powerful things you can do with git. I recommend you to read the [Pro Git book][], especially chapter 7 if you want to discover other advanced tricks with git and chapter 10 to discover how git works internally.</p>

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
  this.page.url = "http://nicolas.porcel.me/posts/2016-12-22-extract-script-from-git-repository.markdown";
  this.page.identifier = "posts/2016-12-22-extract-script-from-git-repository.markdown";
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = '//http-nicolas-porcel-me.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>

        </div>

        <div id="footer">
            Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a><br />
            This blog is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
        </div>
    </body>

    <!--Google Analytics-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-70461809-1', 'auto');
      ga('send', 'pageview');

    </script>
</html>
